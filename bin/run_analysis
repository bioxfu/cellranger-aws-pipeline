#!/usr/bin/env bash

# This script is the entrypoint for all invocations of `cellranger
# count`. It pulls the fastqs and reference transcriptome from s3
# before invoking `cellranger count`.

set -euo pipefail

if [[ "${DEBUG-false}" == "true" ]]; then
  set -x
fi

# SCRATCH_DIR is a 1TB volume.
SCRATCH_DIR="$HOME/scratch"
FASTQS_DIR="$SCRATCH_DIR/fastqs"
OUTPUT_DIR="$SCRATCH_DIR/output"
TRANSCRIPTOME_DIR="$SCRATCH_DIR/transcriptome"
S3_BUCKET=s3://10x-data-backup

usage() {
  echo "$0 CONFIG_JSON"
}

get_from_reference_transcriptome(){
  local key
  key="$1"
  python -c "import json; import sys;
print(json.load(sys.stdin)['sample']['reference_transcriptome']['${key}'])"
}

get_from_sample() {
  local key
  key="$1"
  python -c "import json; import sys;
print(json.load(sys.stdin)['sample']['${key}'])"
}

get_from_config() {
  local key
  key="$1"
  python -c "import json; import sys;
value=json.load(sys.stdin)['${key}']
if type(value) == list:
   print(*value)
else:
   print(value)"
}

fetch_fastqs() {
  local config_json experiment_name sample_name runs
  config_json="$1"
  experiment_name="$(get_from_config experiment_name <<<"$config_json")"
  sample_name="$(get_from_sample name <<<"$config_json")"
  runs="$(get_from_config runs <<<"$config_json")"
  
  for run in $runs; do
    aws s3 cp \
        "${S3_BUCKET}/${experiment_name}/${sample_name}/fastqs/run${run}/" \
        "$FASTQS_DIR/${run}/" \
        --include "*_R[1,2]_*.tar.gz" \
        --recursive
  done

  ls -la $FASTQS_DIR
}

fetch_transcriptome() {
  local config_json version name
  config_json="$1"
  version="$(get_from_reference_transcriptome version <<<"$config_json")"
  name="$(get_from_reference_transcriptome name <<<"$config_json")"

  mkdir -p "$TRANSCRIPTOME_DIR"

  aws s3 cp \
      "s3://10x-pipeline/reference_transcriptome/${name}/refdata-cellranger-${name}-${version}.tar.gz" \
      - \
    | tar -C "$TRANSCRIPTOME_DIR" --strip-components=1 -xvzf -
}

cellranger_analyze() {
  local config_json sample_name chemistry target_cell_count
  config_json="$1"
  sample_name="$(get_from_sample name <<<"$config_json")"
  job_type="$(get_from_sample job_type <<<"$config_json")"
  feature_barcoding="$(get_from_sample feature_barcoding <<<"$config_json")"
  feature_barcoding_enabled = feature_barcoding['enabled']
  echo 'feature_barcoding_enabled'
  echo feature_barcoding_enabled
  echo'----------------'

  mkdir -p "$OUTPUT_DIR"

  if [[ "$job_type" == "count" && feauture_barcoding_enabled == 'False' ]]; then
    chemistry="$(get_from_sample chemistry <<<"$config_json")"
    target_cell_count="$(get_from_sample target_cell_count <<<"$config_json")"

    pushd "$OUTPUT_DIR"; \
      cellranger count \
                 --disable-ui \
                 --chemistry="$chemistry" \
                 --fastqs="$(echo "${FASTQS_DIR}"/* | tr ' ' ,)" \
                 --id="$sample_name" \
                 --sample="$sample_name" \
                 --expect-cells="$target_cell_count" \
                 --transcriptome="$TRANSCRIPTOME_DIR"
    popd
  fi

  # if [[ "$job_type" == "count" && feauture_barcoding_enabled == 'True' ]]; then
  #   chemistry="$(get_from_sample chemistry <<<"$config_json")"
  #   target_cell_count="$(get_from_sample target_cell_count <<<"$config_json")"

  #   pushd "$OUTPUT_DIR"; \
  #     cellranger count \
  #                --disable-ui \
  #                --chemistry="$chemistry" \
  #                --fastqs="$(echo "${FASTQS_DIR}"/* | tr ' ' ,)" \
  #                --id="$sample_name" \
  #                --sample="$sample_name" \
  #                --expect-cells="$target_cell_count" \
  #                --transcriptome="$TRANSCRIPTOME_DIR"
  #   popd
  # fi

  if [[ "$job_type" == "vdj" ]]; then
    pushd "$OUTPUT_DIR"; \
      cellranger vdj \
                 --disable-ui \
                 --fastqs="$(echo "${FASTQS_DIR}"/* | tr ' ' ,)" \
                 --id="$sample_name" \
                 --sample="$sample_name" \
                 --reference="$TRANSCRIPTOME_DIR"
    popd
  fi
}

upload_results() {
  local config_json experiment_name sample_id reference_transcriptome_name
  config_json="$1"
  experiment_name="$(get_from_config experiment_name <<<"$config_json")"
  sample_id="$(get_from_sample name <<<"$config_json")"
  reference_transcriptome_name="$(get_from_reference_transcriptome name <<<"$config_json")"

  aws s3 cp \
      "${OUTPUT_DIR}/${sample_id}" \
      "${S3_BUCKET}/${experiment_name}/${sample_id}/cellranger_analyze_output/${reference_transcriptome_name}"/ \
      --exclude "SC_RNA_COUNTER_CS/*" \
      --recursive
}

main() {
  local config_json

  if [[ -z "${1:-}" ]]; then
    usage
    exit 1
  fi

  config_json="$1"

  fetch_fastqs "$config_json"
  fetch_transcriptome "$config_json"
  cellranger_analyze "$config_json"
  upload_results "$config_json"
}

main "$@"
