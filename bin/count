#!/usr/bin/env bash

# This script is the entrypoint for all invocations of `cellranger
# count`. It pulls the fastqs and reference transcriptome from s3
# before invoking `cellranger count`.

set -euo pipefail

if [[ "${DEBUG-false}" == "true" ]]; then
  set -x
fi

FASTQS_DIR="$HOME/fastqs"
JOBMODE="${JOBMODE:-local}"
TRANSCRIPTOME_DIR="$HOME/transcriptome"

usage() {
  echo "$0 CONFIG_JSON"
}

get_from_reference_transcriptome(){
  local key
  key="$1"
  python -c "import json; import sys;
print(json.load(sys.stdin)['sample']['reference_transcriptome]['${key}'])"
}

get_from_sample() {
  local key
  key="$1"
  python -c "import json; import sys;
print(json.load(sys.stdin)['sample']['${key}'])"
}

get_from_config() {
  local key
  key="$1"
  python -c "import json; import sys;
print(json.load(sys.stdin)['${key}'])"
}

fetch_fastqs() {
  local config_json experiment_name sample_name runs
  config_json="$1"
  experiment_name="$(get_from_config experiment_name <<<"$config_json")"
  runs="$(get_from_config runs <<<"$config_json")"
  sample_name="$(get_from_sample name <<<"$config_json")"
  aws s3 cp \
      "s3://10x-data-backup/${experiment_name}/${sample_name}/fastqs/${run}/" \
      "$FASTQS_DIR" \
      --include "*_R[1,2]_*.tar.gz" \
      --recursive
}

fetch_transcriptome() {
  local config_json version name
  version="$(get_from_reference_transcriptome version <<<"$config_json")"
  name="$(get_from_reference_transcriptome name <<<"$config_json")"
  config_json="$1"
  aws s3 cp \
      # TODO: fix how we store this stuff?
      "s3://10x-pipeline/reference_transcriptome/${name}/${version}/" \
      "$TRANSCRIPTOME_DIR" \
      --recursive
}

cellranger_count() {
  local config_json
  config_json="$1"

  exec cellranger count \
       --chemistry="$(get_from_sample chemistry <<<"$config_json")" \
       --fastqs="$FASTQS_DIR" \
       --jobmode="$JOBMODE" \
       # FIXME: what are the correct values?
       --id="$ID" \
       --sample="$(get_from_sample name <<<"$config_json")" \
       --transcriptome="$TRANSCRIPTOME_DIR"
}

main() {
  local config_json

  if [[ -z "${1:-}" ]]; then
    usage
    exit 1
  fi

  config_json="$1"

  fetch_fastqs "$config_json"
  fetch_transcriptome "$config_json"
  cellranger_count "$config_json"
}

main "$@"
